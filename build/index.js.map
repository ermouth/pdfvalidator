{"version":3,"sources":["../src/index.js"],"names":["pdfjs","PDFJS","window","getSignatures","pdf","acroForm","xref","root","get","sigs","fields","forEach","isRef","field","sigField","fetch","sigFieldType","name","v","byteRange","contents","contentLength","length","contentBuffer","ArrayBuffer","contentView","Uint8Array","i","charCodeAt","asn1","cmsContentSimp","ContentInfo","schema","result","cmsSignedSimp","SignedData","content","push","ranges","start","end","extractTSToken","signerInfos","tsattr","unsignedAttrs","attributes","attr","type","tstoken","values","valueBeforeDecode","ex","verifyCMSHash","signedDataBuffer","Promise","resolve","hashAlgo","digestAlgorithm","algorithmId","then","crypto","digest","messageDigest","signedAttrs","j","valueBlock","valueHex","byteLength","view1","view2","validateSignature","signature","trustedSigningCAs","trustedTimestampingCAs","id","sequence","sigInfo","SignatureInfo","signedDataLen","range","signedData","signedDataView","contentsView","count","verify","signer","data","checkChain","extendedMode","sigVerified","signatureVerified","cert","signerCertificate","certificates","rawCert","toSchema","toBER","certBundle","Certificate","truststore","signerVerified","status","hashAlgorithm","hashVerified","tsToken","hasTS","tsSigned","tsVerified","tsCert","tsCertBundle","tsCertVerified","PDFValidator","buffer","TrustStoreList","validationInfo","ValidationInfo","pdfSignatures","bufferView","PDFDocument","parseStartXRef","parse","isValid","e","isSigned","addTrustStore","removeTrustStore","signatures"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * PDF Validator module\n *\n * By Fotis Loukos <me@fotisl.com>\n * @module pdfvalidator\n */\nimport { Certificate, ContentInfo, SignedData, getAlgorithmByOID, getCrypto } from 'pkijs';\nimport { fromBER } from 'asn1js';\nimport * as pdfjs from './pdf.js';\nimport { SignatureInfo, TrustStoreList, ValidationInfo, verifyChain } from 'eslutils';\nimport './webcrypto';\n\n/**\n * A range in the file.\n * @typedef {Object} Range\n * @property {number} start - The start of the range.\n * @property {number} end - The end of the range.\n */\n\n/**\n * A PDF signature.\n * @typedef {Object} PDFSignature\n * @property {pkijs.SignedData} cmsSignedSimp - A SignedData structure\n * containing the signature\n * @property {Array<Range>} ranges - An array of all ranges signed by this\n * signature.\n */\n\nlet PDFJS;\nif(typeof window === 'undefined')\n  PDFJS = pdfjs.PDFJS;\nelse\n  PDFJS = window.PDFJS;\n\n/**\n * Get all signatures from a PDFDocument.\n * @param {pdfjs.PDFJS.PDFDocument} pdf - The PDF document\n * @return {Array<PDFSignature>} An array of PDFSignature objects describing\n * all signatures found.\n */\nfunction getSignatures(pdf) {\n  const acroForm = pdf.xref.root.get('AcroForm');\n  if(typeof acroForm === 'undefined')\n    return [];\n\n  const sigs = [];\n  const fields = acroForm.get('Fields');\n  fields.forEach(field => {\n    if(PDFJS.isRef(field) === false)\n      return;\n\n    const sigField = pdf.xref.fetch(field);\n    const sigFieldType = sigField.get('FT');\n    if((typeof sigFieldType === 'undefined') || (sigFieldType.name !== 'Sig'))\n      return;\n\n    const v = sigField.get('V');\n    const byteRange = v.get('ByteRange');\n    const contents = v.get('Contents');\n\n    const contentLength = contents.length;\n    const contentBuffer = new ArrayBuffer(contentLength);\n    const contentView = new Uint8Array(contentBuffer);\n\n    for(let i = 0; i < contentLength; i++)\n      contentView[i] = contents.charCodeAt(i);\n\n    const asn1 = fromBER(contentBuffer);\n\n    const cmsContentSimp = new ContentInfo({ schema: asn1.result });\n    const cmsSignedSimp = new SignedData({\n      schema: cmsContentSimp.content\n    });\n\n    sigs.push({\n      cmsSignedSimp,\n      ranges: [\n        {\n          start: byteRange[0],\n          end: byteRange[0] + byteRange[1]\n        },\n        {\n          start: byteRange[2],\n          end: byteRange[2] + byteRange[3]\n        }\n      ]\n    });\n  });\n\n  return sigs;\n}\n\n/**\n * Extract the timestamp token from the unsigned attributes of the CMS\n * signed data.\n * @param {pkijs.SignedData} cmsSignedSimp - The CMS signed data.\n * @return {pkijs.ContentInfo} The timestamp token as a pkijs.ContentInfo\n * object or null if no timestamp is present.\n */\nfunction extractTSToken(cmsSignedSimp) {\n  if(cmsSignedSimp === null)\n    return null;\n\n  if(!('unsignedAttrs' in cmsSignedSimp.signerInfos[0]))\n    return null;\n\n  let tsattr = null;\n\n  cmsSignedSimp.signerInfos[0].unsignedAttrs.attributes.forEach(attr => {\n    if(attr.type === '1.2.840.113549.1.9.16.2.14')\n      tsattr = attr;\n  });\n\n  if(tsattr === null)\n    return null;\n\n  let tstoken = null;\n\n  try {\n    let asn1 = fromBER(tsattr.values[0].valueBeforeDecode);\n    tstoken = new ContentInfo({schema: asn1.result});\n  } catch(ex) {\n  }\n\n  return tstoken;\n}\n\n/**\n * Verify the hash of a some CMS signed data.\n * @param {pkijs.SignedData} cmsSignedSimp - The CMS Signed Data structure\n * @param {ArrayBuffer} signedDataBuffer - The signed data.\n * @return {Promise<boolean>} A promise that resolves to true if the hash is\n * correct, otherwise false.\n */\nfunction verifyCMSHash(cmsSignedSimp, signedDataBuffer) {\n  if((cmsSignedSimp === null) || (signedDataBuffer === null))\n    return Promise.resolve(false);\n\n  const hashAlgo = getAlgorithmByOID(\n    cmsSignedSimp.signerInfos[0].digestAlgorithm.algorithmId);\n  if(!('name' in hashAlgo))\n    return Promise.resolve(false);\n\n  return Promise.resolve().then(() => {\n    const crypto = getCrypto();\n\n    return crypto.digest({ name: hashAlgo.name },\n      new Uint8Array(signedDataBuffer));\n  }).then(result => {\n    let messageDigest = new ArrayBuffer(0);\n    const signedAttrs = cmsSignedSimp.signerInfos[0].signedAttrs;\n\n    // Find messageDigest attribute\n    for(let j = 0; j < signedAttrs.attributes.length; j++) {\n      if(signedAttrs.attributes[j].type === '1.2.840.113549.1.9.4') {\n        messageDigest = signedAttrs.attributes[j].values[0].valueBlock.valueHex;\n        break;\n      }\n    }\n\n    if(messageDigest.byteLength === 0)\n      return false;\n\n    const view1 = new Uint8Array(messageDigest);\n    const view2 = new Uint8Array(result);\n\n    if(view1.length !== view2.length)\n      return false;\n\n    for(let i = 0; i < view1.length; i++) {\n      if(view1[i] !== view2[i])\n        return false;\n    }\n\n    return true;\n  }, result => {\n    return false;\n  });\n}\n\n/**\n * Validate a single signature.\n * @param {PDFSignature} signature - The PDF signature.\n * @param {ArrayBuffer} contents - The contents of the file.\n * @param {eslutils.TrustStoreList} trustedSigningCAs - Trusted document\n * signing CAs.\n * @param {eslutils.TrustStoreList} trustedTimestampingCAs - Trusted document\n * timestamping CAs.\n * @param {number} id - The id of the signature.\n * @return {Promise<eslutils.SignatureInfo>} A promise that is resolved with\n * a SignatureInfo object containing information about the signature.\n */\nfunction validateSignature(signature, contents, trustedSigningCAs,\n  trustedTimestampingCAs, id) {\n  let sequence = Promise.resolve();\n  const sigInfo = new SignatureInfo(id);\n\n  let signedDataLen = 0;\n  signature.ranges.forEach(range => {\n    signedDataLen += (range.end - range.start);\n  });\n  const signedData = new ArrayBuffer(signedDataLen);\n  const signedDataView = new Uint8Array(signedData);\n  const contentsView = new Uint8Array(contents);\n\n  let count = 0;\n  signature.ranges.forEach(range => {\n    for(let i = range.start; i < range.end; i++, count++)\n      signedDataView[count] = contentsView[i];\n  });\n\n  sequence = sequence.then(() => signature.cmsSignedSimp.verify({\n    signer: 0,\n    data: signedData,\n    checkChain: false,\n    extendedMode: true\n  })).then(result => {\n    sigInfo.sigVerified = result.signatureVerified;\n    sigInfo.cert = result.signerCertificate;\n  }, result => {\n    sigInfo.sigVerified = false;\n    sigInfo.cert = result.signerCertificate;\n  });\n\n  sequence = sequence.then(() => {\n    signature.cmsSignedSimp.certificates.forEach(cert => {\n      const rawCert = cert.toSchema().toBER(false);\n      const asn1 = fromBER(rawCert);\n      sigInfo.certBundle.push(new Certificate({ schema: asn1.result }));\n    });\n  });\n\n  trustedSigningCAs.forEach(truststore => {\n    sequence = sequence.then(() => verifyChain(sigInfo.cert,\n      signature.cmsSignedSimp.certificates, truststore.certificates)\n    ).then(result => {\n      sigInfo.signerVerified.push({\n        name: truststore.name,\n        status: result\n      });\n    });\n  });\n\n  const hashAlgo = getAlgorithmByOID(\n    signature.cmsSignedSimp.signerInfos[0].digestAlgorithm.algorithmId);\n  if('name' in hashAlgo)\n    sigInfo.hashAlgorithm = hashAlgo.name;\n\n  if('signedAttrs' in signature.cmsSignedSimp.signerInfos[0]) {\n    sequence = sequence.then(() => {\n      return verifyCMSHash(signature.cmsSignedSimp, signedData);\n    }).then((result) => {\n      sigInfo.hashVerified = result;\n    });\n\n    if('unsignedAttrs' in signature.cmsSignedSimp.signerInfos[0]) {\n      const tsToken = extractTSToken(signature.cmsSignedSimp);\n\n      if(tsToken != null) {\n        sigInfo.hasTS = true;\n\n        try {\n          const tsSigned = new SignedData({ schema: tsToken.content });\n\n          sequence = sequence.then(() => tsSigned.verify({\n            signer: 0,\n            data: signature.cmsSignedSimp.signerInfos[0].signature.valueBlock\n              .valueHex,\n            checkChain: false,\n            extendedMode: true\n          })).then(result => {\n            sigInfo.tsVerified = result.signatureVerified;\n            sigInfo.tsCert = result.signerCertificate;\n          }, result => {\n            sigInfo.tsVerified = false;\n            sigInfo.tsCert = result.signerCertificate;\n          });\n\n          sequence = sequence.then(() => {\n            tsSigned.certificates.forEach(cert => {\n              const rawCert = cert.toSchema().toBER(false);\n              const asn1 = fromBER(rawCert);\n              sigInfo.tsCertBundle.push(new Certificate({ schema: asn1.result }));\n            });\n          });\n\n          trustedTimestampingCAs.forEach(truststore => {\n            sequence = sequence.then(() => verifyChain(sigInfo.tsCert,\n              tsSigned.certificates, truststore.certificates)\n            ).then(result => {\n              sigInfo.tsCertVerified.push({\n                name: truststore.name,\n                status: result\n              });\n            });\n          });\n        } catch(ex) {\n          sigInfo.hasTS = false;\n        }\n      }\n    }\n  } else {\n    /*\n     * If there are no signed attributes, and the hash is computed just from\n     * the original document, then we assume the signer calculated the correct\n     * hash if the signature is correct.\n     */\n    sequence = sequence.then(() => {\n      sigInfo.hashVerified = sigInfo.sigVerified;\n    });\n  }\n\n  return sequence.then(() => sigInfo);\n}\n\n/**\n * PDF Validator class\n */\nexport class PDFValidator {\n  /**\n   * Load a PDF file from a buffer.\n   * @param {ArrayBuffer} buffer - The buffer containing the PDF file.\n   */\n  constructor(buffer) {\n    /**\n     * @type {eslutils.TrustStoreList}\n     * @description Trusted document signing CAs.\n     */\n    this.trustedSigningCAs = new TrustStoreList();\n    /**\n     * @type {eslutils.TrustStoreList}\n     * @description Trusted document timestamping CAs.\n     */\n    this.trustedTimestampingCAs = new TrustStoreList();\n    /**\n     * @type {eslutils.ValidationInfo}\n     * @description A ValidationInfo object holding the validation results.\n     */\n    this.validationInfo = new ValidationInfo();\n    /**\n     * @type {ArrayBuffer}\n     * @description The contents of the file.\n     */\n    this.buffer = buffer;\n    /**\n     * @type {Array<PDFSignature>}\n     * @description The signatures in the file.\n     */\n    this.pdfSignatures = null;\n\n    const bufferView = new Uint8Array(buffer);\n\n    const pdf = new PDFJS.PDFDocument(null, bufferView, null);\n\n    try {\n      pdf.parseStartXRef();\n      pdf.parse();\n    } catch(ex) {\n      return;\n    }\n\n    this.validationInfo.isValid = true;\n\n    try {\n      this.pdfSignatures = getSignatures(pdf);\n    } catch(e) {\n      this.pdfSignatures = [];\n    }\n\n    if(this.pdfSignatures.length > 0)\n      this.validationInfo.isSigned = true;\n  }\n\n  /**\n   * Add a trust store to the document signing trust stores.\n   * @param {TrustStore} truststore - The trust store to add.\n   */\n  addSigningTruststore(truststore) {\n    this.trustedSigningCAs.addTrustStore(truststore);\n  }\n\n  /**\n   * Remove a trust store from the document signing trust stores by name.\n   * @param {string} name - The name of the trust store to remove.\n   */\n  removeSigningTruststore(name) {\n    this.trustedSigningCAs.removeTrustStore(name);\n  }\n\n  /**\n   * Add a trust store to the timestamping trust stores.\n   * @param {TrustStore} truststore - The trust store to add.\n   */\n  addTimestampingTruststore(truststore) {\n    this.trustedTimestampingCAs.addTrustStore(truststore);\n  }\n\n  /**\n   * Remove a trust store from the document signing trust stores by name.\n   * @param {string} name - The name of the trust store to remove.\n   */\n  removeTimestampingTruststore(name) {\n    this.trustedTimestampingCAs.removeTrustStore(name);\n  }\n\n  /**\n   * Validate the PDF file.\n   * @return {Promise<PDFInfo>} A promise that is resolved with a PDFInfo\n   * object containing the validation results.\n   */\n  validate() {\n    let sequence = Promise.resolve();\n\n    if((this.validationInfo.isValid === false) ||\n      (this.validationInfo.isSigned === false))\n      return sequence.then(() => { return this.validationInfo; });\n\n    for(let i = 0; i < this.pdfSignatures.length; i++) {\n      sequence = sequence.then(() => validateSignature(this.pdfSignatures[i],\n        this.buffer, this.trustedSigningCAs, this.trustedTimestampingCAs, i))\n        .then(result => {\n          this.validationInfo.signatures.push(result);\n        });\n    }\n\n    return sequence.then(() => this.validationInfo);\n  }\n}\n"]}