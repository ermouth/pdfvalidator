{"version":3,"sources":["../src/index.js"],"names":["pkijs","asn1js","pdfjs","extractTSToken","cmsSignedSimp","signerInfos","tsattr","unsignedAttrs","attributes","forEach","attr","type","tstoken","asn1","fromBER","values","valueBeforeDecode","ContentInfo","schema","result","ex","verifyCMSHash","signedDataBuffer","Promise","resolve","hashAlgo","getAlgorithmByOID","digestAlgorithm","algorithmId","then","crypto","getCrypto","digest","name","Uint8Array","messageDigest","ArrayBuffer","signedAttrs","j","length","valueBlock","valueHex","byteLength","view1","view2","i","verifyChain","certificate","chain","trustedCAs","newChain","splice","push","certificateChainEngine","CertificateChainValidationEngine","certs","trustedCerts","verify","PDFInfo","isValid","isSigned","sigVerified","hashVerified","hashAlgorithm","signerVerified","hasTS","tsVerified","tsCertVerified","cert","tsCert","PDFValidator","buffer","trustedSigningCAs","trustedTimestampingCAs","pdfInfo","pdf","PDFJS","PDFDocument","parseStartXRef","parse","acroForm","xref","root","get","fields","isRef","sigField","fetch","sigFieldType","v","byteRange","contents","contentLength","contentBuffer","contentView","charCodeAt","cmsContentSimp","SignedData","content","signedDataView","count","certificates","Array","concat","sequence","signer","data","checkChain","extendedMode","signatureVerified","signerCertificate","tsToken","tsSigned","signature"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * PDF Validator module\n *\n * By Fotis Loukos <me@fotisl.com>\n * @module pdfvalidator\n */\nimport * as pkijs from 'pkijs';\nimport * as asn1js from 'asn1js';\nimport * as pdfjs from './pdf.js';\nimport './webcrypto'\n\n/**\n * Extract the timestamp token from the unsigned attributes of the CMS\n * signed data.\n * @param {pkijs.SignedData} cmsSignedSimp - The CMS signed data.\n * @return {pkijs.ContentInfo} The timestamp token as a pkijs.ContentInfo\n * object or null if no timestamp is present.\n */\nfunction extractTSToken(cmsSignedSimp) {\n  if(cmsSignedSimp === null)\n    return null;\n\n  if(!('unsignedAttrs' in cmsSignedSimp.signerInfos[0]))\n    return null;\n\n  let tsattr = null;\n\n  cmsSignedSimp.signerInfos[0].unsignedAttrs.attributes.forEach(attr => {\n    if(attr.type === '1.2.840.113549.1.9.16.2.14')\n      tsattr = attr;\n  });\n\n  if(tsattr === null)\n    return null;\n\n  let tstoken = null;\n\n  try {\n    let asn1 = asn1js.fromBER(tsattr.values[0].valueBeforeDecode);\n    tstoken = new pkijs.ContentInfo({schema: asn1.result});\n  } catch(ex) {\n  }\n\n  return tstoken;\n}\n\n/**\n * Verify the hash of a some CMS signed data.\n * @param {pkijs.SignedData} cmsSignedSimp - The CMS Signed Data structure\n * @param {ArrayBuffer} signedDataBuffer - The signed data.\n * @return {Promise<boolean>} A promise that resolves to true if the hash is\n * correct, otherwise false.\n */\nfunction verifyCMSHash(cmsSignedSimp, signedDataBuffer) {\n  if((cmsSignedSimp === null) || (signedDataBuffer === null))\n    return Promise.resolve(false);\n\n  const hashAlgo = pkijs.getAlgorithmByOID(\n    cmsSignedSimp.signerInfos[0].digestAlgorithm.algorithmId);\n  if(!('name' in hashAlgo))\n    return Promise.resolve(false);\n\n  return Promise.resolve().then(() => {\n    const crypto = pkijs.getCrypto();\n\n    return crypto.digest({ name: hashAlgo.name },\n      new Uint8Array(signedDataBuffer));\n  }).then(result => {\n    let messageDigest = new ArrayBuffer(0);\n    const signedAttrs = cmsSignedSimp.signerInfos[0].signedAttrs;\n\n    // Find messageDigest attribute\n    for(let j = 0; j < signedAttrs.attributes.length; j++) {\n      if(signedAttrs.attributes[j].type === '1.2.840.113549.1.9.4') {\n        messageDigest = signedAttrs.attributes[j].values[0].valueBlock.valueHex;\n        break;\n      }\n    }\n\n    if(messageDigest.byteLength === 0)\n      return false;\n\n    const view1 = new Uint8Array(messageDigest);\n    const view2 = new Uint8Array(result);\n\n    if(view1.length !== view2.length)\n      return false;\n\n    for(let i = 0; i < view1.length; i++) {\n      if(view1[i] !== view2[i])\n        return false;\n    }\n\n    return true;\n  }, result => {\n    return false;\n  });\n}\n\n/**\n * Verify if a certificate chains to some trusted CAs.\n * @param {pkijs.Certificate} certificate - The certificate that will be\n * checked.\n * @param {Array<pkijs.Certificate>} chain - Additional certificates in the\n * chain.\n * @param {Array<pkijs.Certificate>} trustedCAs - The trusted CAs\n * @return {Promise<boolean>} A promise that is resolved with a boolean value\n * stating if the certificate was verified or not.\n */\nfunction verifyChain(certificate, chain, trustedCAs) {\n  if(certificate === null)\n    return Promise.resolve(false);\n\n  const newChain = chain.splice();\n  newChain.push(certificate)\n\n  return Promise.resolve().then(() => {\n    const certificateChainEngine = new pkijs.CertificateChainValidationEngine({\n      certs: newChain,\n      trustedCerts: trustedCAs\n    });\n\n    return certificateChainEngine.verify();\n  }).then(result => {\n    return result.result;\n  }, result => {\n    return false;\n  });\n}\n\n/**\n * Document information definition\n */\nexport class PDFInfo {\n  /**\n   * Generate an empty PDFInfo object.\n   * @constructor\n   */\n  constructor() {\n    /**\n     * @type {boolean}\n     * @description A valid PDF file.\n     */\n    this.isValid = false;\n    /**\n     * @type {boolean}\n     * @description A signed PDF file.\n     */\n    this.isSigned = false;\n    /**\n     * @type {boolean}\n     * @description Signed hash has been verified.\n     */\n    this.sigVerified = false;\n    /**\n     * @type {boolean}\n     * @description The hash corresponds to the signed data.\n     */\n    this.hashVerified = false;\n    /**\n     * @type {string}\n     * @description The algorithm that was used to hash the data.\n     */\n    this.hashAlgorithm = '';\n    /**\n     * @type {boolean}\n     * @description Signer certificate chains to a trusted signing CA.\n     */\n    this.signerVerified = false;\n    /**\n     * @type {boolean}\n     * @description A timestamped PDF file.\n     */\n    this.hasTS = false;\n    /**\n     * @type {boolean}\n     * @description The timestamp has been verified.\n     */\n    this.tsVerified = false;\n    /**\n     * @type {boolean}\n     * @description The certificate of the timestamp chains to a trusted\n     * timestamping CA.\n     */\n    this.tsCertVerified = false;\n    /**\n     * @type {pkijs.Certificate}\n     * @description The signer's certificate.\n     */\n    this.cert = null;\n    /**\n     * @type {pkijs.Certificate}\n     * @description The timestamp authority's certificate.\n     */\n    this.tsCert = null;\n  }\n\n  /**\n   * Check if the file verified was a valid signed PDF whose signature and\n   * signed hash have been verified.\n   */\n  get isValidSigned() {\n    return this.isValid & this.isSigned & this.sigVerified & this.hashVerified;\n  }\n\n  /**\n   * Check if the file verified was a valid signed and timestamped PDF whose\n   * signature, signed hash and timestamp have been verified.\n   */\n  get isValidSignedTimestamped() {\n    return this.isValid & this.isSigned & this.sigVerified &\n      this.hashVerified & this.hasTS & this.tsVerified;\n  }\n\n  /**\n   * Check if the signer has been verified. If the file is timestamped, then\n   * the timestamp signer will also be checked.\n   */\n  get isSignersVerified() {\n    if(!this.isValid || !this.isSigned)\n      return false;\n\n    if(!this.signerVerified)\n      return false;\n\n    if(this.hasTS && !this.tsCertVerified)\n      return false;\n\n    return true;\n  }\n};\n\n/**\n * PDF Validator class\n */\nexport class PDFValidator {\n  /**\n   * Load a PDF file from a buffer.\n   * @param {ArrayBuffer} buffer - The buffer containing the PDF file.\n   */\n  constructor(buffer) {\n    /**\n     * @type {Array<pkijs.Certificate>}\n     * @description Trusted document signing CAs.\n     */\n    this.trustedSigningCAs = [];\n    /**\n     * @type {Array<pkijs.Certificate>}\n     * @description Trusted document timestamping CAs.\n     */\n    this.trustedTimestampingCAs = [];\n    /**\n     * @type {pkijs.SignedData}\n     * @description The SignedData structure of the PDF signature.\n     */\n    this.cmsSignedSimp = null;\n    /**\n     * @type {ArrayBuffer}\n     * @description An ArrayBuffer holding the signed data.\n     */\n    this.signedDataBuffer = null;\n    /**\n     * @type {PDFInfo}\n     * @description A PDFInfo object holding the validation results.\n     */\n    this.pdfInfo = new PDFInfo();\n\n    const pdf = new pdfjs.PDFJS.PDFDocument(null, new Uint8Array(buffer), null);\n\n    try {\n      pdf.parseStartXRef();\n      pdf.parse();\n    } catch(ex) {\n      return;\n    }\n\n    this.pdfInfo.isValid = true;\n\n    const acroForm = pdf.xref.root.get('AcroForm');\n    if(typeof acroForm === 'undefined')\n      return;\n\n    const fields = acroForm.get('Fields');\n    if(pdfjs.PDFJS.isRef(fields[0]) === false)\n      return;\n\n    const sigField = pdf.xref.fetch(fields[0]);\n    const sigFieldType = sigField.get('FT');\n    if((typeof sigFieldType === 'undefined') || (sigFieldType.name !== 'Sig'))\n      return;\n\n    const v = sigField.get('V');\n    const byteRange = v.get('ByteRange');\n    const contents = v.get('Contents');\n\n    const contentLength = contents.length;\n    const contentBuffer = new ArrayBuffer(contentLength);\n    const contentView = new Uint8Array(contentBuffer);\n\n    for(let i = 0; i < contentLength; i++)\n      contentView[i] = contents.charCodeAt(i);\n\n    const asn1 = asn1js.fromBER(contentBuffer);\n\n    const cmsContentSimp = new pkijs.ContentInfo({ schema: asn1.result });\n    this.cmsSignedSimp = new pkijs.SignedData({\n      schema: cmsContentSimp.content\n    });\n\n    this.signedDataBuffer = new ArrayBuffer(byteRange[1] + byteRange[3]);\n    const signedDataView = new Uint8Array(this.signedDataBuffer);\n\n    let count = 0;\n    for(let i = byteRange[0]; i < (byteRange[0] + byteRange[1]); i++, count++)\n      signedDataView[count] = buffer[i];\n\n    for(let j = byteRange[2]; j < (byteRange[2] + byteRange[3]); j++, count++)\n      signedDataView[count] = buffer[j];\n\n    this.pdfInfo.isSigned = true;\n  }\n\n  /**\n   * Add certificates to the trusted signing certificates bundle.\n   * @param {Array<pkijs.Certificate>} certificates - An array of the\n   * certificates to add.\n   */\n  addTrustedSigningCAs(certificates) {\n    if(!(certificates instanceof Array))\n      return;\n\n    this.trustedSigningCAs = this.trustedSigningCAs.concat(certificates);\n  }\n\n  /**\n   * Add certificates to the trusted timestamping certificates bundle.\n   * @param {Array<pkijs.Certificate>} certificates - An array of the\n   * certificates to add.\n   */\n  addTrustedTimestampingCAs(certificates) {\n    if(!(certificates instanceof Array))\n      return;\n\n    this.trustedTimestampingCAs = this.trustedTimestampingCAs.concat(certificates);\n  }\n\n  /**\n   * Validate the PDF file.\n   * @return {Promise<PDFInfo>} A promise that is resolved with a PDFInfo\n   * object containing the validation results.\n   */\n  validateDoc() {\n    let sequence = Promise.resolve();\n\n    if((this.pdfInfo.isValid === false) || (this.pdfInfo.isSigned === false))\n      return sequence.then(() => { return this.pdfInfo; });\n\n    sequence = sequence.then(() => this.cmsSignedSimp.verify({\n      signer: 0,\n      data: this.signedDataBuffer,\n      trustedCerts: this.trustedSigningCAs,\n      checkChain: false,\n      extendedMode: true\n    })).then(result => {\n      this.pdfInfo.sigVerified = result.signatureVerified;\n      this.pdfInfo.cert = result.signerCertificate;\n    }, result => {\n      this.pdfInfo.sigVerified = false;\n      this.pdfInfo.cert = result.signerCertificate;\n    }).then(() => verifyChain(this.pdfInfo.cert,\n      this.cmsSignedSimp.certificates, this.trustedSigningCAs)\n    ).then(result => {\n      this.pdfInfo.signerVerified = result;\n    });\n\n    if('signedAttrs' in this.cmsSignedSimp.signerInfos[0]) {\n      const hashAlgo = pkijs.getAlgorithmByOID(\n        this.cmsSignedSimp.signerInfos[0].digestAlgorithm.algorithmId);\n      if('name' in hashAlgo)\n        this.pdfInfo.hashAlgorithm = hashAlgo.name;\n\n      sequence = sequence.then(() => {\n        return verifyCMSHash(this.cmsSignedSimp, this.signedDataBuffer);\n      }).then((result) => {\n        this.pdfInfo.hashVerified = result;\n      });\n\n      if('unsignedAttrs' in this.cmsSignedSimp.signerInfos[0]) {\n        const tsToken = extractTSToken(this.cmsSignedSimp);\n\n        if(tsToken != null) {\n          this.pdfInfo.hasTS = true;\n\n          const tsSigned = new pkijs.SignedData({ schema: tsToken.content });\n\n          sequence = sequence.then(() => tsSigned.verify({\n            signer: 0,\n            data: this.cmsSignedSimp.signerInfos[0].signature.valueBlock\n              .valueHex,\n            trustedCerts: this.trustedTimestampingCAs,\n            checkChain: false,\n            extendedMode: true\n          })).then(result => {\n            this.pdfInfo.tsVerified = result.signatureVerified;\n            this.pdfInfo.tsCert = result.signerCertificate;\n          }, result => {\n            this.pdfInfo.tsVerified = false;\n            this.pdfInfo.tsCert = result.signerCertificate;\n          }).then(() => {\n            return verifyChain(this.pdfInfo.tsCert, tsSigned.certificates,\n              this.trustedTimestampingCAs)\n          }).then(result => {\n            this.pdfInfo.tsCertVerified = result;\n          });\n        }\n      }\n    }\n\n    return sequence.then(() => this.pdfInfo);\n  }\n}\n"]}